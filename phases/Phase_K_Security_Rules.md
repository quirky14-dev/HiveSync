# Phase K – Security, Privacy & Hardening Planning

> **Purpose of Phase K:**
>
> * Consolidate ALL security-related requirements from across the entire system: backend, workers, mobile, desktop, plugins, tokens, R2, admin.
> * Ensure the final build for Replit has precise, enforceable rules.
> * Integrate previously added items: stateless tokens, MFA-ready account structure, session enforcement, API key restrictions, plugin sandboxing, and admin-only features.
> * **No code generation**.
>
> Replit MUST NOT write or modify any code during Phase K.

---

## K.1. Inputs for This Phase

Replit must read and rely on:

* `/docs/security_hardening.md`
* `/docs/backend_spec.md`
* `/docs/admin_dashboard_spec.md`
* `/phases/Phase_H_AI_and_Preview_Pipeline.md`
* `/phases/Phase_E_Desktop_Client_Planning.md`
* `/phases/Phase_F_Mobile_Tablet_Planning.md`
* `/phases/Phase_G_Plugins_Planning.md`

---

## K.2. Global System Security Principles

1. **Zero-trust assumptions** across every boundary.
2. **Stateless architecture** (tokens, Workers, R2 interactions).
3. **Least privilege** for every user, worker, plugin.
4. **No secrets in clients** (desktop/mobile/plugins).
5. **Backend validates everything** – tokens, permissions, tiers.
6. **Secure-by-default**: no public endpoints except registration/login.
7. **Strict rate limits**: tier-based + route-based.

---

## K.3. Authentication & Session Security

### K.3.1 JWT Access Tokens

* Short-lived.
* Used for most requests.
* Stored in memory (Desktop/Mobile) or secure editor keychain (plugins).

### K.3.2 Refresh Tokens

* Long-lived.
* Stored server-side (DB) with device/session binding.
* Revocation supported via `/api/v1/auth/sessions`.

### K.3.3 Password Handling

* Argon2id hashing.
* No plaintext storage.

### K.3.4 Optional MFA-Ready Structure

Backend must support adding MFA later (TOTP/SMS/app-based) without schema changes.

---

## K.4. API Request Security

Backend must enforce:

* HMAC validation (Workers callbacks)
* Strict JSON schema validation
* Size limits per route
* Per-tier rate limits
* IP-based throttles for public endpoints
* Role-based access controls
* Project membership verification

Errors MUST NOT leak internal details.

---

## K.5. Preview Token Security

Preview tokens are:

* HMAC signed
* Single-use optional (configurable)
* Time-limited (minutes)
* Contain:

  * job_id
  * user_id
  * project_id
  * platform
  * tier
  * allowed devices
* Never stored in plaintext in DB
* Never logged fully

Devices use tokens ONLY to fetch artifacts.

---

## K.6. Workers & R2 Security

### K.6.1 Worker Security

Workers must:

* Run in strict sandbox
* Disable outbound network access
* Limit CPU/GPU time
* Reject oversize bundles
* Mask all environment variables
* Log only non-sensitive data

### K.6.2 R2 Security

* Signed URLs only
* All artifacts private by default
* Objects names must NOT contain user-provided strings
* R2 bucket policies: deny public access

---

## K.7. Desktop Security Rules

Desktop must:

* Store tokens securely in OS keychain
* Never write secrets to logs
* Use sandboxed webviews
* Sign IPC messages
* Validate plugin-originated instructions

Desktop acts as privileged local proxy → MUST be secure.

---

## K.8. Mobile/iPad Security Rules

* Secure token storage (secure keychain)
* No plaintext logs
* Prevent screenshotting of preview tokens (optional config)
* Validate preview tokens before use

---

## K.9. Editor Plugin Security

Plugins must:

* Use secure storage APIs for tokens
* Never store password
* Never write secrets to disk
* Always prefer Proxy Mode
* Use HTTPS for direct backend calls
* Strip PII before logs

---

## K.10. Admin Security Rules

Admin views require:

* Admin JWT with role=admin
* Strict backend permission checks
* No client-side trust

Admin actions require:

* Re-authentication for destructive operations (optional: password or short-lived admin token)

Admin logs:

* Never include full tokens
* Must hide user emails unless necessary

---

## K.11. Webhook & API Key Security

### API Keys

* Generated by backend
* Plaintext shown ONCE
* Stored hashed
* Scoped:

  * read-only
  * write
  * admin (internal use only)

### Webhooks

* Signed with secret
* Retry logic with backoff
* Delivery logs stored in DB

---

## K.12. Logging & Privacy

Backend and workers must:

* Remove PII from logs
* Store timestamps, codes
* Avoid logging full request bodies
* Support log rotation

User-accessible logs (via admin) must redact:

* Emails
* IP addresses (partial only)
* Tokens
* R2 object keys (partial)

---

## K.13. Secure Defaults for Replit Build

Replit must:

* ALWAYS create backend routers with validation
* ALWAYS use Pydantic schemas
* ALWAYS check permissions before returning data
* NEVER leave TODOs
* NEVER add debug endpoints
* NEVER expose internal Worker URLs

All generated code must align with security rules.

---

## K.14. Mapping 102 Feature Categories → Security

Security applies to:

* Preview pipeline
* Workers
* R2
* Tasks/teams/comments
* Search
* API keys
* Webhooks
* Admin
* Tier enforcement
* Authentication
* Error logs
* All mobile/desktop/plugins

---

## K.15. No Code Generation Reminder

During Phase J, Replit must NOT:

* Write backend code
* Write Workers
* Write mobile/desktop/plugins code

This is planning only.

---

## K.16. End of Phase K

At the end of Phase K, Replit must:

* Understand all security rules
* Apply them consistently across all future phases

> When Phase K is complete, stop.
> Wait for the user to type `next` to proceed to Phase L.
