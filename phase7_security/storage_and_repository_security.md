# Storage & Repository Security  
_HiveSync – Phase 7_

## 1. Overview
HiveSync stores sensitive developer assets, including:

- repository mirrors (full source code)  
- preview bundles (mobile preview packages)  
- temporary build artifacts  
- AI job-related material  
- log files and metadata  

This document specifies how all storage—local filesystem, container volumes, and S3-compatible object storage—must be hardened for production.

The goals:

- prevent unauthorized access  
- ensure secrecy of user code  
- guarantee isolation between projects  
- secure cleanup of temporary artifacts  
- maintain an auditable and predictable storage lifecycle  

---

# 2. Repository Mirror Security

Repository mirrors represent **full working copies** of user code.  
They pose the highest risk and require the strongest controls.

## 2.1 Repository Mirror Root Structure
Mirrors are stored under:

```

DATA_DIR/repos/<project_id>/mirror/

```

Each project gets an isolated directory.  
No sharing, no symlinks, no reuse across users.

---

## 2.2 File Permission Model

- Only backend + worker service user may read/write.  
- No world-readable permissions.  
- No group-readable permissions unless isolated by group ID.  
- On Linux:

```

chown backend:backend DATA_DIR/repos/<id>
chmod 700 DATA_DIR/repos/<id>

```

- Production must use encrypted disk/volume.

---

## 2.3 No Direct Serving of Repos
Mirrors must **never** be exposed via:

- static hosting  
- file servers  
- direct HTTP endpoints  
- cloud bucket ACLs  

**Backend must always mediate access.**

---

## 2.4 Git Credential Security

Workers performing repo sync must use:

- ephemeral deploy keys OR  
- short-lived cloud credentials  
- no personal SSH keys  

SSH keys stored in:

```

DATA_DIR/keys/<project_id>/

```

Permissions:

```

chmod 600

```

Keys must **never** be printed, logged, or returned in any error response.

---

## 2.5 Sanitizing Repo Paths

To prevent path traversal:

- workers must reject paths containing:
  - `..`
  - `~`
  - absolute paths  
  - symlinks inside mirrors  
- backend provides canonical paths only  

All sync operations work only through validated safe paths.

---

## 2.6 Repo Mirror Cleanup & Rotation

Automatic cleanup required for:

- repos inactive more than X days  
- failed clone attempts  
- orphaned directories  

Workers perform:

- depth reduction  
- pruning of stale branches  
- validation of `.git` integrity  

Optionally:

- compress cold mirrors  
- archive old mirrors  

---

# 3. Preview Bundle Security

Preview bundles are generated by the desktop client and sent to backend for mobile consumption.

They contain:

- compiled/packaged mobile preview  
- assets used in preview  
- potentially sensitive code (depending on framework)

## 3.1 Bundle Storage Location

```

DATA_DIR/previews/<session_id>/<bundle_file>

```

Where `<session_id>` is randomized, non-sequential, and unpredictable.

---

## 3.2 Security Requirements

### 3.2.1 Access Control
- Only backend + workers read/write preview bundles  
- Mobile clients may **only download** with a valid preview_token  
- Never expose bundles via public URLs  
- Signed URLs optional (future)

---

### 3.2.2 File Permission Standards

```

chown backend:backend
chmod 600

```

No group/world access.

---

### 3.2.3 Bundle Name Entropy
Preview bundles must:

- use random UUID or hash-based filenames  
- avoid predictable naming patterns  
- avoid embedding user/project metadata in filenames  

---

### 3.2.4 Bundle Retention
Bundles expire when:

- preview_token expires  
- mobile completes download  
- cleanup worker runs periodic sweeps  
- operator manually resets previews  

Default retention: **10–30 minutes**.

No bundle should persist beyond a user session.

---

# 4. Temporary File Security

Preview builds, AI jobs, and repo sync all create temporary files.

## 4.1 Temp Location Isolation
Temp directories stored under:

```

DATA_DIR/tmp/<random>

```

Rules:

- created per operation  
- never shared  
- deleted immediately upon job completion  
- cleared on service restart  

---

## 4.2 Safe Creation Rules
All temporary files must be created using safe APIs:

- Python: `tempfile.mkdtemp()`  
- Node: `fs.mkdtemp()`  

Avoid manual randomization.

---

## 4.3 No Sensitive Temp Logging
Logs must never contain:

- full temp paths  
- file contents  
- bundle internals  

---

# 5. Object Storage Security (Optional Mode)

HiveSync may store:

- preview bundles  
- AI job artifacts (future)  
- logs (future audit pipelines)  

## 5.1 Private Bucket ACLs
Buckets must:

- block all public access  
- disallow listing  
- require signed URLs (optional future)  
- encrypt at rest (SSE-S3, SSE-KMS, or cloud equivalent)  

---

## 5.2 Randomized Object Keys
Never expose:

- project_id  
- user_id  
- repository details  

Use hash-based keys:

```

previews/<token_hash>/<bundle_hash>

```

---

## 5.3 Expiration Policies
Configure object storage lifecycle rules:

- auto-delete previews after X hours  
- auto-delete failure artifacts  
- retain logs based on operator’s compliance rules  

---

# 6. Encryption Requirements

## 6.1 Encryption at Rest  
Mandatory for:

- repo mirrors  
- preview bundles  
- DB volumes  
- object storage  

## 6.2 Encryption in Transit  
Mandatory:

- HTTPS for all client→backend traffic  
- HTTPS for backend→object-storage traffic  

---

# 7. Monitoring & Alerting for Storage

Operators must monitor for:

- spikes in preview downloads (possible scraping)  
- sudden growth in repo mirror disk usage  
- repeated failed repo sync attempts  
- unexpected bundle retention  
- unauthorized access attempts  
- checksum mismatches  

---

# 8. Incident Response Requirements

If a preview bundle or repo mirror is suspected compromised:

1. Revoke user JWTs  
2. Rotate preview_token signing secret  
3. Reset active preview sessions  
4. Rotate object storage keys  
5. Trigger repo mirror cleanup  
6. Audit recent access logs  
7. Notify affected users (if required)  

---

# 9. Cross-References

- security_hardening_overview.md  
- backend_security_hardening.md  
- client_security_hardening.md  
- ci_cd_security.md  
- monitoring_and_alerts.md  
- audit_logging.md
