# HiveSync Master Specification (Merged, Updated, Authoritative — With Plugin ↔ Desktop Flexible Proxy Mode)

> **Design System Compliance:**  
> All UI layout, components, colors, typography, spacing, and interaction patterns in this document MUST follow the official HiveSync Design System (`design_system.md`).  
> No alternate color palettes, spacing systems, or component variations may be used unless explicitly documented as an override in the design system.  
> This requirement applies to desktop, mobile, tablet, web, admin panel, and IDE plugin surfaces.

This is the controlling document for Replit’s build phases.

---

# 1. System Overview

HiveSync is a multi-platform developer toolchain providing:

* Live mobile preview on real devices (stateless token pipeline)
* AI-based documentation generation (CPU/GPU job system)
* Desktop, mobile, iPad, and editor plugin clients
* Teams, tasks, comments, notifications
* Admin analytics & worker autoscaling
* Secure object storage integration
* Flexible plugin ↔ desktop routing model

Core components:

* **FastAPI Backend** (main orchestrator)
* **Worker Pools** (CPU/GPU)
* **Object Storage** (Linode S3)
* **PostgreSQL** (primary DB)
* **Redis** (rate limits, queues, ephemeral state)
* **Desktop Client** (Electron)
* **Mobile App** (React Native)
* **iPad Enhanced App**
* **Editor Plugins** (VS Code, JetBrains, Sublime, Vim)
* **Admin Dashboard**

---

# 2. Architectural Principles

* Stateless preview tokens
* Object storage presigned URLs
* Worker-sandboxed builds
* Backend orchestration
* Clients hold no plaintext secrets
* Replit-friendly deterministic build instructions
* Flexible Proxy Mode for editor plugins

---

# 3. Data Model Summary

Entities:

* Users
* Teams
* TeamMembers
* Projects
* Tasks
* Comments
* AI Jobs
* Preview Sessions (logged, not stateful)
* Notifications
* Workers
* Audit Logs

All defined via SQLAlchemy + Pydantic with consistent timestamp & ID conventions.

---

# 4. API Domains


* `/users` — profile, settings, tier
* `/teams` — team membership, roles
* `/projects` — metadata and file lists
* `/tasks` — project tasks
* `/comments` — inline/general comments
* `/notifications` — unified notifications feed
* `/preview` — stateless preview build pipeline
* `/ai` — AI documentation jobs
* `/repos` — optional git sync
* `/workers` — worker callbacks & heartbeats
* `/rate_limits` — abuse detection
* `/health` — shallow & deep checks
* `/admin` — analytics, scaling, audit logs
* `/auth` — login, register, tokens, one-time session-token generation for automatic website login
* `/billing` — subscription checkout, LemonSqueezy webhook, tier enforcement

> **Billing System Integration:**  
> HiveSync’s backend MUST implement all billing logic as defined in `billing_and_payments.md`.  
> This includes:  
> - authenticated checkout initiation via `/billing/start-checkout`  
> - attaching `user_id` metadata to LemonSqueezy checkout sessions  
> - processing all subscription lifecycle events via `/billing/webhook`  
> - verifying webhook HMAC signatures  
> - updating user tiers, subscription status, renewal dates  
> - enforcing per-tier limits (preview, AI docs, refactors, queue priority)  
>  
> The frontend MUST NOT communicate directly with LemonSqueezy.  
> All billing actions must flow through the backend following the rules defined in `billing_and_payments.md`.

All endpoints standardized using JSON envelopes.

---

# 5. Preview Pipeline (Stateless)

This is HiveSync’s signature subsystem.

Flow:

1. Desktop/plugin requests preview
2. Backend verifies project & rate limits
3. Backend issues **stateless preview token** (signed, short-lived)
4. Worker builds preview bundle
5. Worker uploads bundle to S3 (presigned PUT)
6. Backend notifies clients
7. Mobile downloads bundle via presigned GET

Security:

* No secrets in bundle
* Token expires < 10 minutes
* Validates project + file hash

# **5.1 Sandbox Interactive Mobile Preview System (Authoritative Specification)**

HiveSync includes a **Sandbox Interactive Preview System** that allows developers to view and interact with a simulated version of their mobile UI on a physical device **without executing user code**, while remaining fully compliant with iOS App Store and Android Play Store policies.

This system is built around three pillars:

1. **Local Component Engine (LCE)** inside the HiveSync mobile app
2. **Layout JSON**, generated by backend analysis of user code
3. **A safe interaction + state simulation model**, including a console overlay for suppressed actions

This section defines the full specification required for Replit to build this subsystem.

---

## **5.1.1 Local Component Engine (LCE)**

The HiveSync mobile app contains a pre-approved library of components:

```
HS_View
HS_Text
HS_Image
HS_Button
HS_Input
HS_Scroll
HS_List
HS_SafeArea
HS_NavContainer
HS_NavScreen
HS_Spacer
HS_Overlay
```

These components:

* Are defined and shipped within the HiveSync app binary
* Do NOT load, execute, or interpret user JavaScript
* Can be safely arranged to simulate RN UI behavior
* Support native scrolling, press states, text input, and gesture handling
* Are driven entirely by **Layout JSON**, never by user code execution

The LCE is a **runtime-safe virtual UI engine**, not a JS execution environment.

---

## **5.1.2 Layout JSON Specification**

The backend analyzes user code (JS/TSX) and produces a **Layout JSON Tree** describing:

* Component types
* Styles (flexbox, margins, paddings, fonts)
* Text nodes
* Placeholder images
* Interaction handlers (names only)
* Navigation hints

Example:

```json
{
  "screenId": "home",
  "navType": "stack",
  "components": [
    {
      "id": "v1",
      "type": "HS_View",
      "style": { ... },
      "children": [
        {
          "id": "btn-login",
          "type": "HS_Button",
          "props": { "label": "Login", "handlerName": "handleLogin" },
          "style": { ... }
        }
      ]
    }
  ]
}
```

**Forbidden inside Layout JSON**:

* Functions
* JavaScript code
* Dynamic imports
* Arbitrary expressions
* Native module references

The JSON is **declarative, not executable**.

---

## **5.1.3 Rendering and Interaction Model**

Upon receiving Layout JSON:

1. LCE builds a full UI tree
2. Yoga computes layout
3. Native RN components render instantly
4. UI components behave interactively **using HiveSync logic**, not user code

Supported behaviors:

* Button press highlight
* ScrollView scrolling + inertia
* Text input focus + keyboard
* Navigation animations
* Shadow, border, flexbox rendering

Unsupported (suppressed):

* User-defined JS execution
* Running async functions
* Calling navigation logic from user code
* Network requests
* File access
* Custom native modules

Whenever a suppressed action would occur, the system logs it and displays a console overlay message.

---

## **5.1.4 Event Handling Rules**

All touches are handled locally unless navigation requires new Layout JSON.

### **Local-only (no backend call):**

* Button press
* Scroll
* Text entry
* Press animations
* State toggles simulated locally
* Input validation (visual only)

### **Backend-triggered:**

* Screen navigation (if JSON defines `"navigateTo"`)
* Layout changes due to code edits
* Requests for recomposition
* Deep component substitution requiring backend context

---

## **5.1.5 Navigation Simulation**

Navigation JSON:

```json
"navActions": {
  "onPress": { "navigateTo": "details" }
}
```

Device behavior:

1. Play local navigation animation
2. Request new Layout JSON from backend
3. Replace UI declaratively

All navigation transitions MUST be deterministic and visually consistent.

---

## **5.1.6 Sandbox Console Overlay**

A top-of-screen overlay communicates suppressed actions.

### **Default (Idle) State**

* Height: 3 lines of text tall (~60–80px)
* Opacity: 0.10
* Touch pass-through enabled
* No meaningful impact on UI interaction

### **Expanded State (when a sandbox event occurs)**

* Height animates to **30% of screen height**
* Opacity animates to **0.40**
* Touches inside this region are consumed (not passed to UI)
* Displays an explanatory message such as:

  ```
  Sandbox: "handleLogin" triggered. User code not executed.
  ```
* Shrinks back to idle after 1.5–2.0 seconds

Animation timing:

* Expand: 250–300ms ease-out
* Collapse: 250–300ms ease-in

---

## **5.1.7 Touch Pass-Through Rules**

To prevent UI interaction from being blocked:

* Idle console → ALWAYS pass touches through
* Expanded console → consume touches only within expanded region
* Chrome (pulsing frame + top banner) → never intercept touches

All other touches MUST be forwarded to LCE components.

---

## **5.1.8 Sandbox Chrome (Visual Indicators)**

To clearly indicate preview mode:

### **1. Pulsing Frame**

* 1 px border around entire device screen
* Color oscillation between `#FFA500` and `#FFD700`
* Pulse duration: 1.5 seconds
* Purely decorative; no touch effect

### **2. Sandbox Banner**

* Centered top label: `"SANDBOX PREVIEW"`
* 1 px border
* Minimal height
* Always visible

These elements ensure Apple reviewers understand the preview is not a real app.

---

## **5.1.9 Logging Requirements**

Every sandbox event must be logged:

```
timestamp
projectId
screenId
componentId
handlerName (if any)
message
deviceId
sessionId
```

Logs are append-only and visible in Preview Logs in desktop + plugins.

---

## **5.1.10 Backend Responsibilities**

The backend MUST:

* Parse user files into a component tree
* Extract structural + style information
* Generate Layout JSON deterministically
* Resolve assets to S3 URLs
* Provide navigation targets
* Provide error messages for unsupported patterns
* Never return any executable code to the device

Workers remain fully stateless.

---

## **5.1.11 Mobile App Responsibilities**

The mobile app MUST:

* Render Layout JSON via LCE
* Handle local interactivity instantly
* Only contact backend when navigation requires new Layout JSON
* Enforce console overlay behavior
* Render sandbox chrome consistently
* Never execute user JS or dynamic code


---

# 6. AI Documentation Pipeline

1. Client selects code
2. Backend enqueues AI job (CPU/GPU)
3. Worker processes
4. Result stored in S3
5. Notification sent
6. Client fetches result

Supports snippet, full-file, and multi-file.

---

# 7. Teams, Tasks, Comments, Notifications

### Teams

* Create teams
* Assign roles (Owner/Admin/Member)
* Manage access

### Tasks

* Assigned to users
* Status + comments
* Triggers notifications

### Comments

* Inline and general
* Project-scoped

### Notifications

* Unified feed
* Preview ready
* AI job done
* Mentions
* Team events

---

# 8. Client Platforms

## 8.1 Desktop (Electron)

* Project browser
* Code editor
* AI docs panel
* Comment panel
* Preview send modal
* Settings, tier, help/FAQ
* Acts as **local proxy** for plugins (when installed)

## 8.2 Mobile (React Native)

* Tabs: Files, AI Docs, Notifications, Tasks, Settings
* Stateless preview runtime
* Swipe-based comment panel

## 8.3 iPad Enhanced UI

* Split-screen + multi-panel layouts
* Ideal for code review + preview

## 8.4 Editor Plugins

* VS Code / JetBrains / Sublime / Vim
* Commands: AI Docs, Send Preview, Notifications
* Automatic Flexible Proxy Mode support

---

# 9. Plugin ↔ Desktop Flexible Proxy Mode (NEW, CRITICAL)

Editor plugins support **two silent, automatic routing modes**.

## 9.1 Direct Mode → plugin talks directly to backend

Used when:

* Desktop not installed
* Desktop installed but not running
* Desktop unreachable

In Direct Mode:

* Plugin stores JWT in OS keychain
* Plugin → backend over HTTPS
* Previews & AI jobs work with stateless tokens

## 9.2 Proxy Mode → plugin routes through desktop

Used when Desktop **is installed & running**.

Flow:

```
Plugin → Desktop local API → Backend → Workers
```

Desktop adds:

* Local file hashing
* Path normalization
* Richer project metadata
* Silent JWT refresh
* Centralized preview logs

## 9.3 Silent Automatic Switching (Option A)

Plugins attempt connection at startup:

1. Try `http://localhost:{port}/hivesync-desktop-api`
2. If reachable → Proxy Mode
3. If unreachable → Direct Mode

No UI messages.
No prompts.
No user action.

Switching is instant and automatic.

## 9.4 Security

* Tokens always stored in OS keychain
* Desktop never stores plaintext secrets
* Plugin ↔ Desktop traffic is localhost only
* Backend sees consistent authentication regardless of mode

## 9.5 Impact on Preview Pipeline

Direct Mode:

* Plugin sends file list

Proxy Mode:

* Desktop computes file list accurately
* Better path normalization

## 9.6 Impact on AI Docs

Proxy mode improves multi-file support.

---

# 10. Admin System

Admin features:

* Worker list + heartbeats
* Queue depths + GPU/CPU usage
* Preview failure analytics
* AI job analytics
* Rate-limit spikes
* Audit logs (all admin actions logged)
* Autoscaling rules

---

# 11. Deployment Model

* Docker Compose for local and production
* Linode compute for backend and workers
* Linode S3 for storage
* Managed Postgres + Redis, or containerized equivalents
* Proper environment template separation

Environments:

* local
* staging
* production

---

# 12. Security Model

* Argon2 passwords
* JWT rotation
* Strict rate limits
* Path normalization
* No secrets in logs
* Presigned URLs short-lived
* Worker sandbox execution
* CI/CD secret hygiene

Proxy Mode-specific:

* Localhost-only proxy channel
* Desktop handles JWT securely
* Plugin can fail over safely

---

# 13. Pricing & Tiers

### Free

* CPU previews
* Basic AI docs

### Pro

* Faster previews
* Larger AI jobs

### Premium

* GPU previews
* Priority queue
* Largest AI limits

### Admin

* Full analytics
* Scaling controls
* Audit log search


## **Upgrade Flow Specification (Reader-App Compliant)**

HiveSync does not perform in-app purchases inside mobile or desktop clients. All subscription upgrades must occur on the HiveSync website, accessed through external links defined via environment variables.

### A. Trigger Conditions

The upgrade modal is triggered whenever the backend returns:

```json
{ "error": "tier_upgrade_required", "required_tier": "pro" }
```

or

```json
{ "error": "tier_upgrade_required", "required_tier": "premium" }
```

Frontend clients must map these to the correct modal:

* Free → Pro
* Free → Premium
* Pro → Premium

### B. Modal Behavior

Clients must show a modal explaining the restriction and provide a link to the website using the exact wording:

* “This feature isn’t available on your current plan. You can view HiveSync plans on our website.”
* “This is a Premium-only feature. You can view HiveSync plans on our website.”
* “This feature is available on Premium plans. You can manage your subscription on our website.”

Button text must be:
**“Open Website”**

### C. Link Handling via Environment Variables

Each platform must open the correct upgrade page using:

```
HIVESYNC_UPGRADE_URL_MOBILE
HIVESYNC_UPGRADE_URL_DESKTOP
```

This ensures:

* iOS/Android open the mobile-friendly upgrade page
* Desktop/Plugins open the full website subscription page

### D. Forbidden Patterns

To remain compliant with App Store and Play Store policy:

* No “subscribe”, “upgrade”, or “buy” language
* No direct checkout links in mobile apps
* No in-app subscription UI
* No deep linking to Stripe checkout
* No “upgrade in this app” phrasing
* Only external website-based plan management is allowed

---

# 14. Error Model

Unified envelope codes:

* AUTH_INVALID
* AUTH_EXPIRED
* VALIDATION_ERROR
* NOT_FOUND
* RATE_LIMITED
* PREVIEW_BUILD_FAILED
* AI_JOB_FAILED
* INTERNAL_ERROR

---

# 15. Logging & Monitoring

* Worker failures
* Preview statistics
* AI job durations
* Rate-limit triggers
* Admin actions

Admin dashboard shows real-time and historical data.

---

# 16. Autoscaling

Scaling rules based on queue depth:

* CPU pool
* GPU pool

Admin controls thresholds.

---

# 17. Replit Build Phase Rules (CRITICAL)

Phases A–O MUST:

* Append only in designated sections
* Never overwrite environment templates
* Never modify unauthorized directories
* Always preserve document structure
* Produce deterministic outputs

Allowed write dirs:

* backend/app
* backend/tests
* worker
* mobile
* desktop
* plugins
* docs
* docker

Forbidden:

* New top-level dirs not predeclared
* Writing secrets

---

# 18. Help/FAQ Integration

Appears in:

* Desktop settings
* Mobile settings
* Plugin command palette
* Admin header

Covers:

* Preview pipeline
* AI docs usage
* Device linking
* Tier differences
* Troubleshooting

---

# 19. Non-Functional Requirements

* 95%+ build reliability
* Predictable behavior across clients
* Low preview latency (<2s target)
* Fast AI job turnaround
* horizontal worker scaling
* Robust fallback logic

---

# 20. Summary

This Master Specification is complete, merged, and authoritative.
It includes all previously missing old-phase features, all new A–O content, and the restored Flexible Proxy Mode routing behavior.

**This file governs the entire HiveSync build.**
