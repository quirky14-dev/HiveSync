# üìÑ **ui_architecture_map_viewer.md**

HiveSync UI Specification ‚Äî Architecture Map Viewer
Version 1.0
Authoritative Document

---

# 1. Overview

The Architecture Map Viewer is the core visualization environment in HiveSync.
It displays:

* Nodes (files, components, functions, services, models, routes)
* Edges (imports, exports, calls, data flow, containment, route links)
* Map versions generated by the Architecture Map Worker

This document defines UI behavior for:

* Desktop (Electron) ‚Äî **full split-view environment**
* Mobile & Tablet (React Native) ‚Äî **read-only viewer**
* Shared controls
* Zoom slider
* Breadcrumb path bar
* Refresh banner
* Event Flow Mode (Desktop-only integration)

## Language Support Indicators

If a file belongs to a language not fully supported by static parsing, map viewer must:

* Display node normally
* Show an ‚ÄúInference Mode‚Äù badge
* Tooltip:
`This node was analyzed using AI-assisted inference. Some relationships may be approximate. Always Check.`


* Nodes derived from AI-only inference must use dashed borders.

All implementations must follow this document strictly so UI code remains consistent across platforms.

---

# 2. Desktop UI ‚Äî Split View Layout

**Parsing Dependency:**  
Node coloration, edge visibility, uncertain-node styling, and runtime/static reconciliation MUST follow the confidence scoring and uncertainty semantics defined in `parser_accuracy_stack.md`.  
Low-confidence nodes MUST be rendered with the defined uncertainty indicators.

The desktop map screen is a **two-panel split view**:

```
+---------------------------------------------------------------+
| [Breadcrumb Path Bar]                                         |
+------------------------------+--------------------------------+
|        Left Panel            |          Right Panel           |
|     Architecture Map         |   File Viewer / Quick Edit     |
|                              |                                |
|  (interactive graph canvas)  |  (shows file contents or AI    |
|                              |   results tied to selected     |
|                              |   nodes)                       |
+------------------------------+--------------------------------+
| [Zoom Slider]                |                                |
+---------------------------------------------------------------+
```

## 2.1 Layout Rules

### Left Panel: Map Canvas

* Interactive graph (pan/zoom/mousewheel)
* Node click selects the corresponding element and:

  * Highlights node
  * Expands edges/relationships
  * Loads corresponding file/component into the **Right Panel**

* Shift-click:
  * Multi-select nodes (Premium-only for advanced exploration mode later)

* Double-click node:
  * Centers and zooms node
  * Opens file directly into the Right Panel


#### Desktop File Opening Behavior (Extended)

When a node representing a real file is double-clicked:
- Desktop client MUST show a non-blocking selector **only if multiple editors are available**:
- **Open in HiveSync Editor** (default)
- **Open in Local IDE** (VS Code / JetBrains via plugin)
- If a plugin is installed, the Desktop client MUST default to opening the file in the IDE quietly.
- If no IDE integration exists, OS default editor may be used.


iPad:
- Double-click (or double-tap) opens the file **inside HiveSync** only.
- iPad MUST NOT attempt to open external IDEs.



### Right Panel: File Viewer / Quick Edit

* When a node is selected ‚Üí show linked file + scroll to definition range
* Quick Edit Mode enabled for Pro/Premium:

  * Local buffer
  * Unsaved changes detection
  * Rename preview overlays
* Premium-only:

  * Architecture Diff overlays (if diff mode activated)
  * Event Flow path highlighting (Section 6)

### Split Resizing

* Middle vertical drag handle adjusts panel width
* Defaults to 50/50 split
* Minimum width:

  * Map Panel ‚â• 400px
  * File Panel ‚â• 350px

## 2.2 Layer Toggle Bar (HTML / CSS / Code / External Layers)

The map viewer MUST include a horizontal toggle bar above the map canvas:
`[Code] [HTML] [CSS] [External] [API] (Premium) [EventFlow]`

### 2.2.1 Color Conventions (Token-Based)

All colors MUST reference tokens in design_system.md (Section 2.6).

* Code nodes ‚Üí node-code-fill + node-code-border
* HTML nodes ‚Üí node-html-fill + node-html-border
* CSS nodes ‚Üí node-css-fill + node-css-border
* External nodes ‚Üí node-external-fill + node-external-border (or good/bad variant)
* API nodes ‚Üí node-api-fill + node-api-border
* Unknown nodes ‚Üí node-unknown-fill + node-unknown-border
* AI-touched nodes ‚Üí node-ai-fill + node-ai-border
* Error nodes ‚Üí node-error-fill + node-error-border

Boundary (external) reachability:

* reachable ‚Üí node-external-border-good
* unreachable ‚Üí node-external-border-bad
* unknown ‚Üí node-external-border


### Behavior:

* **Code** ‚Äì Default layer. Shows traditional architecture nodes (files, functions, components).
* **HTML** ‚Äì Shows HTML file nodes + element nodes.
* **CSS** ‚Äì Shows CSS file nodes, selector nodes, and rule groups.
* **External** ‚Äì Shows boundary nodes representing remote CSS/JS/assets.
* **API** ‚Äì Shows endpoints as nodes (if imported from Phase D specs).
* **EventFlow** ‚Äì Auto-enabled only during Premium EventFlow sessions.

Layers may be multi-selected.  
Turning a layer OFF hides the associated nodes and edges.

---

## **2.3 Progressive Reveal & Density Controls**

To avoid overwhelming users and to maintain smooth interaction on projects of any size, the Architecture Map Viewer MUST progressively reveal details rather than render all nodes/edges at once.

### **2.3.1 Level-Based Reveal**

The renderer MUST reveal the map in 3 passes:

1. **Pass 1 ‚Äî Skeleton / High-Level Modules**

   * Show only top-level folders, root files, and entrypoints.
   * Edges thinner and semi-transparent.

2. **Pass 2 ‚Äî Mid-Level Components**

   * Reveal files + components within expanded folders.
   * Reveal imports/edges only within the same module cluster.

3. **Pass 3 ‚Äî Full Detail**

   * Reveal all remaining edges and nodes.
   * Reveal nested components, functions, and selectors (if HTML/CSS layers are active).

Each pass MUST animate with a **fade-in from 0% ‚Üí 100% opacity** over ~250ms.

### **2.3.2 Density Throttling**

If node density exceeds safe rendering limits:

```
MAX_NODES_VISIBLE = 500
MAX_EDGES_VISIBLE = 800
```

the viewer MUST:

* Hide low-confidence edges first
* Hide non-critical components (functions, selectors)
* Replace dense regions with **cluster nodes**, e.g.:

```
/components/ (97)
```

Clusters MUST expand only when clicked or zoomed sufficiently.

### **2.3.3 Edge Thinning Rules**

Edges MUST dynamically change thickness based on zoom level:

* Zoomed out ‚Üí edges thin (0.5px), low-opacity
* Mid zoom ‚Üí normal thickness (1px)
* Zoomed in ‚Üí full thickness (1.75px) with arrowheads

Edge thinning reduces visual clutter and GPU load.

### **2.3.4 Node Fade-In Sequencing**

When switching layers or loading a new map version:

* Nodes MUST fade in **staggered**, 10‚Äì20ms apart
* Sequence order:

  1. Root nodes
  2. Imported files
  3. Components
  4. Functions/selectors (if enabled)

This creates a readable progression and avoids sudden visual ‚Äújumps.‚Äù

### **2.3.5 Collapse & Expand Behavior**

When compressing or expanding clusters:

* Expansion MUST animate outward with nodes sliding into place
* Collapse MUST animate inward and replace nodes with a cluster box
* Animations MUST complete within 150‚Äì200ms to maintain responsiveness

### **2.3.6 EventFlow Overlay Compatibility**

When EventFlow layer is active:

* Progressive reveal must prioritize showing the event path‚Äôs active nodes
* Non-path nodes MAY be temporarily hidden
* Node glow/pulse animations MUST take precedence over reveal animations

---

# 3. Mobile / Tablet Map Viewer (Read-Only)

Mobile & Tablet have the same UX logic with responsive differences.

### 3.1 Interaction Rules

* **Pinch to zoom**
* **Drag to pan**
* Tap node ‚Üí shows a bottom sheet with:

  * Node name
  * Node type
  * File path
  * "Open in file browser"
  * (Premium) ‚ÄúShow relationships‚Äù
* Long-press ‚Üí highlight dependent nodes (incoming + outgoing edges)
* No file editing in mobile
* No map generation (Pro/Premium only allowed on desktop)

### 3.2 Restricted Capabilities (Mobile/Tablet)

* Node double-click does nothing
* Edge inspection is limited to hover-equivalent tap
* Event Flow Mode:

  * Mobile **sends** events
  * Mobile **does not display** flow animations

#### iPad Map Viewer Capability (Clarification)

The iPad client MUST expose the **full Architecture Map Viewer**, including:
- Node selection
- Detail sheets
- Boundary node reachability indicators
- Inline path editing rules as defined above

Event Flow Mode visualization remains **Desktop-only** and MUST NOT be enabled on iPad.

---

# 4. Shared UI Elements

## 4.1 Zoom Slider

Displayed on **Desktop only**, anchored bottom-left of the map panel.

```
[-] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚óè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [+]
     minZoom          maxZoom
```

### Behavior:

* Drag thumb ‚Üí continuous zoom
* Click -/+ ‚Üí step zoom at 10% increments
* Double-click thumb ‚Üí auto-center
* Auto-center ALWAYS:

  * Repositions viewport so selected node is centered
  * Animation duration: 200‚Äì300ms (ease-out)

Minimum zoom: 20%
Maximum zoom: 300%

If user hits max zoom ‚Üí

* Show a subtle shake animation to indicate boundary

---

## 4.2 Breadcrumb Path Bar

Located **above the split view**, aligned left.

```
File.js  ‚Ä∫  ComponentA  ‚Ä∫  Function foo()
```

### Behavior:

* Shows hierarchical path from file ‚Üí component ‚Üí function
* Items are clickable:

  * Click "File.js" ‚Üí scroll file viewer to top
  * Click "ComponentA" ‚Üí highlight component node
  * Click "foo()" ‚Üí highlight specific node or range
* Always reflects the **currently selected node** in the map

### Breadcrumb Data Source:

* Derived from architecture metadata:

  * Node metadata: `{file_path, parent_component, parent_function}`

### Overflow Rules:

If breadcrumb path exceeds available width:

* Collapse middle items into dropdown:

```
File.js ‚Ä∫ ‚Ä¶ ‚Ä∫ foo()
```

---

# 5. Refresh Banner (Map Version Sync UX)

Used when worker produces a new Architecture Map version.

Appears as a temporary banner **top-right** of the map screen:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ New architecture map version available. ‚îÇ
‚îÇ             [ Refresh ]                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Behavior:

* Triggered when:

  * Worker pushes `map_ready` event AND
  * The map screen is open AND
  * The client holds an outdated version
* Banner animates in (slide down + fade)
* Clicking **Refresh**:

  * Fetches latest version via `/architecture/map/latest`
  * Re-renders graph
  * Re-runs selected node highlight (if any)

### Auto-dismiss:

* If user takes no action after 8 seconds ‚Üí fade out
* Reappears on next worker event if map is still outdated

### Offline Impact:

* If offline: banner does NOT show
* When reconnecting:

  * `/auth/me` checks online status
  * If outdated version exists ‚Üí show the banner immediately

---

# 6. Event Flow Mode (Desktop UI Integration)

Event Flow Mode visually highlights UI interactions from the preview device.

**Entry Condition:**
* User is on **Desktop Architecture Map screen**
* User initiates a preview **from the same screen**
* User tier = **Premium**

**UI Behaviors:**

## 6.1 Node Highlighting Animation

When event arrives:

* Flash highlight on matching node (500‚Äì700ms)
* If event has a path:

  * Animate dependency chains
  * Each edge pulses once in propagation order

## 6.2 Event Stream Overlay

Small panel bottom-right:

```
Recent Interactions
----------------------------------
Tap ‚Üí ButtonA
Navigate ‚Üí PageSettings
Focus ‚Üí InputEmail
```

* Shows last 5 events
* Items fade out after 12 seconds

## 6.3 Auto-stop UI

If:

* Preview ends
* User navigates away from map screen
* Client loses premium status

‚Üí overlay hides, animations stop, session ends.

## 6.4 Selector Muting Simulation (Premium)

Premium users may ‚Äúmute‚Äù CSS selectors to preview how the UI would behave without them.

**Controls:**

Each selector row contains:
`[ ] Mute selector`


When muted:
* Selector node dims (40% opacity)
* Influence edges fade out
* HTML nodes update highlight to reflect new lineage dominance
* If multiple selectors muted ‚Üí recomputation occurs per mute state

**Backend Dependency:**
* The viewer sends `muted_selectors: [...]` to the upcoming simulation endpoint (defined in Phase D).
* Viewer MUST apply updated lineage metadata returned by backend.

---

# 7. Edge Highlight Rules

Hover / focus on a node highlights:

* Outgoing edges: `accent-blue` (100% opacity).
* Incoming edges: `accent-blue` at reduced opacity (‚âà50%).
* Selected edges: `accent-blue` with increased stroke width (e.g. 2px).
* Broken/errored edges (from worker): `error` color with dashed line.


## 7.1 CSS Node Representation (Selectors, Rules, Properties)

CSS nodes must follow a hierarchical visual grouping:

### Collapsed Form

```
styles/main.css
12 selectors
```

## Expanded Form
* `.button` ‚Äì selector node  
* `.container` ‚Äì selector node  
* `#login` ‚Äì selector node  
* `@media (min-width: 768px)` ‚Äì media group  
* Inside media groups ‚Üí nested selector nodes  

### Node Behavior:

* Clicking a selector highlights:
  * All HTML nodes it influences
  * All overridden selectors
  * All inheritable ancestors

* Hovering a selector shows tooltip:
```
Selector: .button
Specificity: 0,1,0
Applied Rules: 3
Overridden By: layout.css:12
```

* Clicking a CSS file node expands/collapses selector tree.

## 7.2 CSS Influence Analysis (CIA) Visualization

CIA mode (basic or deep) determines how much CSS-to-HTML behavior is rendered.

## Basic Mode (Free/Pro)
* Show which selectors apply to which HTML nodes
* Dominant rule highlighted with a blue border
* Overridden rules shown as thin gray edges

## Deep Mode (Premium)
* Draw full override lineage graph:
  * `css_override` edges (red)
  * `css_inherit` edges (yellow)
  * `css_specificity` arcs (purple)
* Show ‚ÄúDominant Rule‚Äù badge next to selectors
* Show specificity score in tooltip
* Display media-query conditioning

### HTML Node CSS Summary

When HTML Layer + CSS Layer are both ON, clicking an HTML node shows:
```
Selectors applied: 6
Dominant: .button-primary
Overridden: .button, .container
Inherited: body {...}
```


### Node Density Handling

If more than 20 selectors apply to one HTML node:
* Collapse influence edges
* Show aggregated indicator:
`+17 collapsed selectors`

## 7.3 Boundary Nodes (External CSS/JS/Assets)

Boundary nodes represent remote dependencies such as:

* CDN-hosted CSS
* CDN-hosted JS bundles
* Images, fonts, or other external assets

### Visual Rules:
* Dashed outline
* Soft blue tint background
* Globe icon prefix
* Tooltip shows full URL

### Behavior:
* Clicking node shows ‚ÄúExternal reference only ‚Äî no content available.‚Äù
* Influence edges may originate from boundary nodes if selector references exist (CSS only).

### 7.3.1 Boundary Node Reachability Indicator (Backend-Supplied)

If the backend attaches reachability metadata for an external URL (via a safe HEAD request), the viewer MUST render a small state indicator on the Boundary Node:

* **Green dot** ‚Üí reachable (status 200‚Äì399)
* **Red dot** ‚Üí unreachable (status 400+, timeout, DNS failure)
* **Gray dot** ‚Üí unknown (no metadata, backend did not check)

#### 7.3.2 Inline External Path Edit Workflow (NEW)

Boundary Nodes representing external URLs or asset paths MUST support lightweight inline editing inside the Node Detail Sheet.


**Workflow:**
1. User clicks a Boundary Node with `reachability.reachable=false` or unknown.
2. Detail Sheet displays the external URL/path.
3. If the path is textual and originates from project source code:
- A small inline text field appears beside the path.
- Editing this field updates a **local pending edit buffer**.
- A small `!` badge appears on the node, indicating a local uncommitted modification.
4. When the user finishes editing (blur or Enter):
- Viewer sends `POST /api/v1/projects/{project_id}/architecture/external/test` with the updated path.
- Backend performs a HEAD-only reachability check.
- Viewer updates the reachability dot: red ‚Üí green if reachable.
5. A **Commit Fix** button appears inside the detail sheet if the new path is valid.
6. Clicking **Commit Fix**:
- Sends a file-patch request (single-line replacement) to the backend.
- Triggers incremental Architecture Map regeneration.
- Removes the `!` badge.
- Refreshes the map to reflect corrected reachability.

#### Tooltip Format

When hovering a boundary node with metadata:

```

URL: [https://cdn.example.com/main.css](https://cdn.example.com/main.css)
Reachable: Yes / No / Unknown
Status: 200 / Timeout / DNS Error / -
Last Checked: 2025-01-15 03:12 UTC

```

If no metadata exists, tooltip MUST omit the reachability fields.

#### Behavior Rules

* UI MUST NOT perform network checks itself.
* Viewer MUST rely entirely on backend metadata.
* Indicators must remain visible at all zoom levels ‚â• 40%.
* When zoomed out too far, indicators collapse into:
```
‚óè External (Reachability Hidden at Zoom Level)
```

This feature applies to ALL boundary nodes: CSS, JS, images, fonts, JSON files, HTML external references, or any absolute URL.

### 7.4 Dynamic Runtime Node Discovery (NEW)

Runtime discovery allows HiveSync to create nodes dynamically when the preview system emits events referencing components, modules, or UI elements that were not detected by static parsing.

Dynamic nodes MUST:
- Be added gradually using a 1.5s breathing animation.
- Use temporary runtime-specific tokens (`node-runtime-discovered-flash`, `node-runtime-discovered-temp`).
- Be placed using deterministic location heuristics.
- Never trigger a full-map reflow.

#### 7.4.1 Trigger Conditions
A dynamic node MUST be created when:
- Preview emits an event with a `filePath` or `componentName`, AND
- No existing node in the map corresponds to that element.

Events include:
- `componentMounted`
- `onPress` / `onTap`
- `navigationEvent`
- Any Event Flow event referencing a `sourceFile` or `componentId`.

#### 7.4.2 1.5s Breathing Animation Sequence
- **Phase 1 ‚Äî Appearance Flash (200ms):** white flash using `node-runtime-discovered-flash`.
- **Phase 2 ‚Äî Breathing Glow (1.0s):** pulsing between 60‚Äì75% opacity using `node-runtime-discovered-temp`.
- **Phase 3 ‚Äî Settle (300ms):** fade into final fill/border colors.

#### 7.4.3 Placement Rules
Priority order:
1. Insert under parent node if identified.
2. Cluster with file‚Äôs folder group.
3. Else insert into **Runtime-Only Components** region (right side).

#### 7.4.4 Node Behavior
Dynamic nodes MUST:
- Behave like normal nodes.
- Display a small `runtime` badge.
- Show tooltip: *‚ÄúDiscovered at runtime (not in static map)‚Äù*.

#### 7.4.5 Reconciliation
If a future static scan detects the file:
- Badge is removed.
- Node transitions into a static node with a merge fade animation.

---

# 8. Color & Theme Consistency

All map and UI color usage must follow `design_system.md`:

* Nodes must use the token-based fills and borders defined in design_system.md (Section 2.6).
* Selected Node: Blue glow
* Event Flow Mode highlights: Pulsing Blue
* Errors: System Red
* Zoom Slider track: Gray-700, thumb: Hive-Yellow
* Breadcrumb text: Gray-100
* Background: Dark Mode-First design

---

# 9. Performance Requirements

### Desktop:

* Map must maintain ‚â• 45fps panning/zooming
* Max nodes visible before decimation: 1200
* Use WebGL canvas renderer

### Mobile:

* Use GPU-accelerated canvas
* Rendering must gracefully reduce detail scaling when zoomed out

### Tablet:

* Between Desktop and Mobile rules
* Higher node-label density allowed

---

# 10. Accessibility

* Keyboard Navigation:

  * Tab cycles between nodes
  * Arrow keys pan the viewport (slow)
  * * / ‚Äì keys trigger zoom slider

* Screen Reader Titles:

  * Node name
  * Node type
  * File path

---

# 11. Offline Mode (Read-Only Behavior)

When offline:

* Map loads from cache or last known version
* Zoom, pan, breadcrumb allowed
* No map generation
* No diff
* No event flow
* No refresh banner
* A small tag appears top-left:

  ```
  [Offline Mode]
  ```
* On reconnect:

  * Refresh banner may show
  * Tier is synced
  * Event flow reenabled if applicable

---

# END OF FILE

Authoritative UI spec. No placeholders.
All platforms must use these rules.